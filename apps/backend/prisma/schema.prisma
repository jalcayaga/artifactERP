datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

// --------------------
// Enums
// --------------------

enum UserRole {
  SUPERADMIN
  ADMIN
  EDITOR
  VIEWER
  CLIENT
  CASHIER
  WAREHOUSE_MANAGER
  WEB_SALES
}

enum Action {
  manage
  create
  read
  update
  delete
}

model Role {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  users       User[]         @relation("UserToRole")
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  action      Action
  subject     String
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

enum ProductType {
  PRODUCT
  SERVICE
}

enum OrderStatus {
  PENDING_PAYMENT
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  BANK_TRANSFER
  WEBPAY
  MERCADO_PAGO
  OTHER
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  INVOICED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  VOID
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
  TRIALING
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum IndicatorType {
  UF
  USD
  UTM
}

enum PriceListType {
  RETAIL
  WEB
  WHOLESALE
  OFFER
}

enum SalesModel {
  ONE_TIME
  SUBSCRIPTION
}

enum SocialProvider {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  TIKTOK
}

// --------------------
// Multi-tenant core
// --------------------

model Tenant {
  id            String           @id @default(cuid())
  slug          String           @unique
  name          String
  displayName   String
  isActive      Boolean          @default(true)
  primaryDomain String?
  domains       String[]         @default([])
  settings      Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  branding      TenantBranding?
  users         User[]
  companies     Company[]
  products      Product[]
  lots          Lot[]
  orders        Order[]
  purchases     Purchase[]
  quotes        Quote[]
  invoices      Invoice[]
  payments      Payment[]

  subscriptions Subscription[]
  contactPeople ContactPerson[]
  categories    Category[]
  warehouses    Warehouse[]
  purchaseOrders PurchaseOrder[]
  receptions     Reception[]
  priceLists     PriceList[]
  cashRegisters  CashRegister[]
  posShifts      PosShift[]
  dteCafs        DteCaf[]

  // Logistics
  couriers       Courier[]
  dispatches     Dispatch[]

  integrationConfigs IntegrationConfig[]
  socialAccounts     SocialAccount[]
  socialConversations SocialConversation[]
  socialMessages      SocialMessage[]
  channelOffers       ChannelOffer[]

  @@map("tenants")
}

model TenantBranding {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  logoUrl          String?
  secondaryLogoUrl String?
  primaryColor     String?
  secondaryColor   String?
  accentColor      String?
  lightTheme       Json?
  darkTheme        Json?
  homeSections     Json?
  socialLinks      Json?
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

// --------------------
// User & company domain
// --------------------

model User {
  id               String   @id @default(cuid())
  tenantId         String
  email            String
  password         String
  firstName        String?
  lastName         String?
  role             UserRole @default(CLIENT)
  roles            Role[]   @relation("UserToRole")
  isActive         Boolean  @default(true)
  profilePictureUrl String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  posShifts        PosShift[]

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders    Order[]
  companies Company[]
  quotes    Quote[]

  @@index([tenantId])
  @@unique([tenantId, email])
  @@map("users")
}

model Company {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  name        String
  fantasyName String?
  rut         String?
  giro        String?
  address     String?
  city        String?
  state       String?
  zip         String?
  phone       String?
  email       String?
  isClient    Boolean  @default(false)
  isSupplier  Boolean  @default(false)
  createdAt   DateTime @now()
  updatedAt   DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactPeople ContactPerson[]
  quotes        Quote[]
  invoices      Invoice[]
  orders        Order[]
  purchases     Purchase[]
  purchaseOrders PurchaseOrder[]

  branches      Branch[]

  subscriptions Subscription[]
  dteCafs        DteCaf[]
  socialConversations SocialConversation[]

  @@index([tenantId])
  @@index([userId])
  @@unique([tenantId, rut])
  @@unique([tenantId, email])
  @@map("companies")
}

model ContactPerson {
  id          String   @id @default(cuid())
  tenantId    String
  companyId   String
  firstName   String
  lastName    String?
  email       String?
  phone       String?
  role        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@unique([tenantId, email])
  @@map("contact_people")
}

// --------------------
// Catalog & inventory
// --------------------

model Product {
  id                String      @id @default(cuid())
  tenantId          String
  name              String
  productType       ProductType @default(PRODUCT)
  sku               String?
  barcode           String?     @unique
  brand             String?
  description       String?
  longDescription   String?     @db.Text
  images            String[]    @default([])
  technicalSheetUrl String?
  category          String?
  categoryId        String?
  categoryRef       Category?   @relation(fields: [categoryId], references: [id])
  price             Decimal
  unitPrice         Decimal?
  unit              String?     @default("UN") // e.g. UN, KG, L
  unitId            String?
  unitRef           Unit?       @relation(fields: [unitId], references: [id])
  reorderLevel      Int?
  isPublished       Boolean     @default(false)
  
  // Digital & Sales fields
  salesModel        SalesModel  @default(ONE_TIME)
  fulfillmentUrl    String?     // Link to downloadable or external resource
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  purchaseItems PurchaseItem[]
  purchaseOrderItems PurchaseOrderItem[]
  receptionItems     ReceptionItem[]
  lots          Lot[]
  quoteItems    QuoteItem[]
  invoiceItems  InvoiceItem[]
  subscriptions Subscription[]
  productPrices ProductPrice[]
  channelOffers ChannelOffer[]

  @@index([tenantId])
  @@index([category])
  @@index([categoryId])
  @@index([isPublished])
  @@unique([tenantId, sku])
  @@map("products")
}

// ... (Category, Warehouse, Lot models remain)

model PurchaseOrder {
  id             String    @id @default(cuid())
  tenantId       String
  companyId      String
  orderNumber    String
  status         String    @default("DRAFT") // DRAFT, ISSUED, PARTIALLY_RECEIVED, COMPLETED, CANCELLED
  issueDate      DateTime  @default(now())
  deliveryDate   DateTime?
  totalAmount    Decimal   @db.Decimal(10, 2)
  currency       String    @default("CLP")
  notes          String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company    Company             @relation(fields: [companyId], references: [id])
  items      PurchaseOrderItem[]
  receptions Reception[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([companyId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  unitPrice       Decimal       @db.Decimal(10, 2)
  totalPrice      Decimal       @db.Decimal(10, 2)
  
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model Reception {
  id              String   @id @default(cuid())
  tenantId        String
  purchaseOrderId String?
  warehouseId     String
  receptionNumber String?
  receptionDate   DateTime @default(now())
  status          String   @default("COMPLETED")
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])
  warehouse     Warehouse       @relation(fields: [warehouseId], references: [id])
  items         ReceptionItem[]

  @@index([tenantId])
  @@index([purchaseOrderId])
  @@index([warehouseId])
  @@map("receptions")
}

model ReceptionItem {
  id          String    @id @default(cuid())
  receptionId String
  productId   String
  quantity    Int
  lotId       String?   // Link to the specific lot created

  reception Reception @relation(fields: [receptionId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])
  lot       Lot?      @relation(fields: [lotId], references: [id])

  @@index([receptionId])
  @@index([productId])
  @@map("reception_items")
}

model Category {
  id          String     @id @default(cuid())
  tenantId    String
  name        String
  slug        String
  description String?
  parentId    String?

  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@unique([tenantId, slug])
  @@index([parentId])
  @@map("categories")
}

model Warehouse {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  address     String?
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lots        Lot[]
  receptions  Reception[]

  @@map("warehouses")
}

model Lot {
  id              String        @id @default(cuid())
  tenantId        String
  productId       String
  purchaseItemId  String?
  lotNumber       String
  initialQuantity Int
  currentQuantity Int
  committedQuantity Int @default(0)
  purchasePrice   Decimal       @db.Decimal(10, 2)
  entryDate       DateTime      @default(now())
  expirationDate  DateTime?
  location        String?
  warehouseId     String?
  warehouse       Warehouse?    @relation(fields: [warehouseId], references: [id])

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id])
  purchaseItem PurchaseItem? @relation(fields: [purchaseItemId], references: [id])
  orderItemLots OrderItemLot[]
  receptionItems ReceptionItem[]
  quoteItems    QuoteItem[]

  @@index([tenantId])
  @@index([productId])
  @@index([entryDate])
  @@unique([tenantId, lotNumber])
  @@map("lots")
}

// --------------------
// Orders & purchases
// --------------------

enum OrderSource {
  WEB
  POS
  ADMIN
  MERCADO_LIBRE
  UBER_EATS
  PEDIDOS_YA
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  TIKTOK
}

model Order {
  id               String         @id @default(cuid())
  tenantId         String
  userId           String
  companyId        String
  source           OrderSource    @default(WEB)
  status           OrderStatus    @default(PENDING_PAYMENT)
  paymentStatus    PaymentStatus  @default(PENDING)
  subTotalAmount   Decimal
  vatAmount        Decimal
  vatRatePercent   Float          @default(19.0)
  discountAmount   Decimal        @default(0)
  shippingAmount   Decimal        @default(0)
  grandTotalAmount Decimal
  currency         String         @default("CLP")
  shippingAddress  String?        @db.Text
  billingAddress   String?        @db.Text
  customerNotes    String?        @db.Text
  paymentMethod    PaymentMethod?
  posShiftId       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt


  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Restrict)
  orderItems OrderItem[]
  invoice    Invoice?
  posShift   PosShift? @relation(fields: [posShiftId], references: [id])
  dispatches Dispatch[]

  // Integration fields
  channelId       String?
  externalOrderId String?

  @@index([tenantId])
  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@map("orders")
}

model Purchase {
  id             String   @id @default(cuid())
  tenantId       String
  companyId      String
  purchaseDate   DateTime @default(now())
  status         String   @default("PENDING")
  subTotalAmount Decimal  @db.Decimal(10, 2)
  totalVatAmount Decimal  @db.Decimal(10, 2)
  grandTotal     Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id])
  items   PurchaseItem[]

  @@index([tenantId])
  @@index([companyId])
  @@map("purchases")
}

model PurchaseItem {
  id                String  @id @default(cuid())
  purchaseId        String
  productId         String
  quantity          Int
  unitPrice         Decimal @db.Decimal(10, 2)
  totalPrice        Decimal @db.Decimal(10, 2)
  itemVatAmount     Decimal @db.Decimal(10, 2)
  totalPriceWithVat Decimal @db.Decimal(10, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])
  lots     Lot[]

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
}

model OrderItem {
  id                String  @id @default(cuid())
  orderId           String
  productId         String
  quantity          Int
  unitPrice         Decimal @db.Decimal(10, 2)
  totalPrice        Decimal @db.Decimal(10, 2)
  itemVatAmount     Decimal @db.Decimal(10, 2)
  totalPriceWithVat Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  orderItemLots OrderItemLot[]
  dispatchItems DispatchItem[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderItemLot {
  id            String @id @default(cuid())
  orderItemId   String
  lotId         String
  quantityTaken Int

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  lot       Lot       @relation(fields: [lotId], references: [id], onDelete: Restrict)

  @@unique([orderItemId, lotId])
  @@map("order_item_lots")
}

// --------------------
// Quotes & invoicing
// --------------------

model Quote {
  id             String      @id @default(cuid())
  tenantId       String
  companyId      String
  userId         String
  status         QuoteStatus @default(DRAFT)
  quoteDate      DateTime    @default(now())
  expirationDate DateTime?
  subTotalAmount Decimal     @db.Decimal(10, 2)
  vatAmount      Decimal     @db.Decimal(10, 2)
  grandTotal     Decimal     @db.Decimal(10, 2)
  notes          String?     @db.Text
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  tenant     Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company    Company @relation(fields: [companyId], references: [id])
  user       User    @relation(fields: [userId], references: [id])
  quoteItems QuoteItem[]

  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@map("quotes")
}

model QuoteItem {
  id                String   @id @default(cuid())
  quoteId           String
  productId         String
  quantity          Int
  unitPrice         Decimal  @db.Decimal(10, 2)
  totalPrice        Decimal  @db.Decimal(10, 2)
  itemVatAmount     Decimal  @db.Decimal(10, 2)
  totalPriceWithVat Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  lot     Lot?    @relation(fields: [lotId], references: [id])
  lotId   String?

  @@index([quoteId])
  @@index([productId])
  @@index([lotId])
  @@map("quote_items")
}

model Invoice {
  id             String        @id @default(cuid())
  tenantId       String
  orderId        String        @unique
  companyId      String
  invoiceNumber  String
  status         InvoiceStatus @default(DRAFT)
  issueDate      DateTime      @default(now())
  dueDate        DateTime?
  subTotalAmount Decimal       @db.Decimal(10, 2)
  vatAmount      Decimal       @db.Decimal(10, 2)
  grandTotal     Decimal       @db.Decimal(10, 2)
  notes          String?       @db.Text
  dteProvider    String?
  dteType        Int?          // 33: Factura, 39: Boleta, 61: Nota Credito
  dteStatus      String?       // PENDING, GENERATED, SENT, ACCEPTED, REJECTED
  dteFolio       Int?
  dteTrackId     String?       // SII Track ID
  dteSignature   String?       // Digital Signature
  xmlContent     String?       @db.Text
  dteXmlUrl      String?
  dtePdfUrl      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order    Order    @relation(fields: [orderId], references: [id])
  company  Company  @relation(fields: [companyId], references: [id])
  items    InvoiceItem[]
  payments Payment[]

  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@unique([tenantId, invoiceNumber])
  @@map("invoices")
}

model DteCaf {
  id              String   @id @default(cuid())
  tenantId        String
  companyId       String
  dteType         Int      // 33: Factura, 39: Boleta, etc.
  folioStart      Int
  folioEnd        Int
  lastFolioUsed   Int      @default(0)
  cafXml          String   @db.Text
  privateKey      String   @db.Text
  publicKey       String   @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company         Company  @relation(fields: [companyId], references: [id])

  @@index([tenantId])
  @@index([companyId])
  @@map("dte_cafs")
}

model InvoiceItem {
  id                String   @id @default(cuid())
  invoiceId         String
  productId         String
  quantity          Int
  unitPrice         Decimal  @db.Decimal(10, 2)
  totalPrice        Decimal  @db.Decimal(10, 2)
  itemVatAmount     Decimal  @db.Decimal(10, 2)
  totalPriceWithVat Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(cuid())
  tenantId    String
  invoiceId   String
  amount      Decimal       @db.Decimal(10, 2)
  paymentDate DateTime      @default(now())
  paymentMethod PaymentMethod
  notes       String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// --------------------
// Subscriptions
// --------------------

model Subscription {
  id                String             @id @default(cuid())
  tenantId          String
  companyId         String
  productId         String
  status            SubscriptionStatus @default(ACTIVE)
  interval          BillingInterval    @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd  DateTime
  nextBillingDate   DateTime
  price             Decimal            @db.Decimal(10, 2)
  paymentMethod     PaymentMethod?
  cancelAtPeriodEnd Boolean            @default(false)
  canceledAt        DateTime?
  trialEnd          DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([nextBillingDate])
  @@map("subscriptions")
}

// --------------------
// Locations & Branches
// --------------------

model Branch {
  id        String   @id @default(cuid())
  companyId String
  name      String
  address   String?
  city      String?
  communeId String?
  phone     String?
  code      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  commune   Commune?  @relation(fields: [communeId], references: [id])
  warehouses Warehouse[]

  @@index([companyId])
  @@index([communeId])
  @@map("branches")
}

model Region {
  id          String    @id @default(cuid())
  name        String
  romanNumber String?
  number      Int?
  communes    Commune[]

  @@map("regions")
}

model Commune {
  id       String   @id @default(cuid())
  name     String
  regionId String
  region   Region   @relation(fields: [regionId], references: [id])
  branches Branch[]

  @@index([regionId])
  @@map("communes")
}

// --------------------
// Units of Measure
// --------------------

model Unit {
  id          String    @id @default(cuid())
  tenantId    String?   // Global units have null tenantId
  name        String    // e.g. Kilogramo, Litro, Unidad
  abbreviation String   // e.g. KG, L, UN
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@unique([tenantId, abbreviation])
  @@map("units")
}

// --------------------
// Economic Indicators
// --------------------

model EconomicIndicator {
  id        String        @id @default(cuid())
  indicator IndicatorType
  value     Decimal       @db.Decimal(10, 2)
  date      DateTime
  source    String?
  createdAt DateTime      @default(now())

  @@unique([indicator, date])
  @@map("economic_indicators")
}

// --------------------
// Pricing & Inventory
// --------------------

model PriceList {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  type        PriceListType @default(RETAIL)
  currency    String   @default("CLP")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prices      ProductPrice[]

  @@map("price_lists")
  @@index([tenantId])
}

model ProductPrice {
  id          String   @id @default(cuid())
  priceListId String
  productId   String
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  priceList   PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([priceListId, productId])
  @@map("product_prices")
}

// --------------------
// Logistics
// --------------------

model Courier {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  contactName   String?
  email         String?
  phone         String?
  websiteUrl    String?
  integrationType String? // MANUAL, STARKEN_API, CHILEXPRESS_API
  apiKey        String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dispatches Dispatch[]

  @@index([tenantId])
  @@map("couriers")
}

enum DispatchStatus {
  DRAFT
  ISSUED
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

model Dispatch {
  id             String         @id @default(cuid())
  tenantId       String
  orderId        String
  courierId      String?
  dispatchNumber String?        // Folio Gu√≠a Despacho
  trackingNumber String?
  status         DispatchStatus @default(DRAFT)
  dispatchDate   DateTime       @default(now())
  estimatedArrival DateTime?
  shippingCost   Decimal        @default(0) @db.Decimal(10, 2)
  notes          String?        @db.Text
  
  // Sender/Receiver info snapshot
  originAddress      String?
  destinationAddress String?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order        Order          @relation(fields: [orderId], references: [id])
  courier      Courier?       @relation(fields: [courierId], references: [id])
  items        DispatchItem[]

  @@index([tenantId])
  @@index([orderId])
  @@index([courierId])
  @@map("dispatches")
}

model DispatchItem {
  id          String   @id @default(cuid())
  dispatchId  String
  orderItemId String
  quantity    Int
  
  dispatch    Dispatch  @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])

  @@index([dispatchId])
  @@index([orderItemId])
  @@map("dispatch_items")
}

// --------------------
// POS Domain
// --------------------

model CashRegister {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  code        String?
  macAddress  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shifts      PosShift[]

  @@unique([tenantId, code])
  @@map("cash_registers")
}

model PosShift {
  id            String    @id @default(cuid())
  tenantId      String
  cashRegisterId String
  userId        String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  initialCash   Decimal   @default(0)
  finalCash     Decimal?  
  status        String    @default("OPEN") // OPEN, CLOSED
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashRegister  CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id])
  orders        Order[]

  @@index([tenantId])
  @@index([cashRegisterId])
  @@index([userId])
  @@map("pos_shifts")
}

model IntegrationConfig {
  id        String   @id @default(cuid())
  tenantId  String
  provider  OrderSource
  config    Json     // API keys, tokens, webhooks secrets
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@map("integration_configs")
}

// --------------------
// Social Commerce
// --------------------

model SocialAccount {
  id           String         @id @default(cuid())
  tenantId     String
  provider     SocialProvider
  instanceName String         // name in Evolution API
  token        String         // API Key for this instance
  status       String         @default("DISCONNECTED")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations SocialConversation[]

  @@unique([tenantId, instanceName])
  @@map("social_accounts")
}

model SocialConversation {
  id           String         @id @default(cuid())
  tenantId     String
  accountId    String
  platform     SocialProvider
  externalId   String         // Phone number or handle
  contactId    String?        // Link to Company (ERP Client)
  lastMessage  String?        @db.Text
  unreadCount  Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account      SocialAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact      Company?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  messages     SocialMessage[]

  @@unique([accountId, externalId])
  @@map("social_conversations")
}

model SocialMessage {
  id             String         @id @default(cuid())
  tenantId       String
  conversationId String
  direction      String         // "IN" or "OUT"
  content        String?        @db.Text
  mediaPath      String?        // Path in Supabase Storage bucket
  mediaType      String?        // image, audio, video, document
  externalId     String?        // ID from provider
  timestamp      DateTime       @default(now())

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation   SocialConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([conversationId])
  @@map("social_messages")
}

model ChannelOffer {
  id          String      @id @default(cuid())
  tenantId    String
  channel     OrderSource
  productId   String
  price       Decimal     @db.Decimal(10, 2)
  isActive    Boolean     @default(true)
  metadata    Json?       // ML category, PedidosYa tags, etc.
  
  // For specialized inventory: list of Lot IDs allowed for this channel.
  // Empty = Any lot (standard strategy).
  allowedLotIds String[]  @default([])

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([tenantId, channel, productId])
  @@index([tenantId])
  @@index([channel])
  @@index([productId])
  @@map("channel_offers")
}
