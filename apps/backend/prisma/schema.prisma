datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x"]
}

// --------------------
// Enums
// --------------------

enum UserRole {
  SUPERADMIN
  ADMIN
  EDITOR
  VIEWER
  CLIENT
}

enum Action {
  manage
  create
  read
  update
  delete
}

model Role {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  users       User[]         @relation("UserToRole")
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  action      Action
  subject     String
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

enum ProductType {
  PRODUCT
  SERVICE
}

enum OrderStatus {
  PENDING_PAYMENT
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  BANK_TRANSFER
  OTHER
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  INVOICED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  VOID
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
  TRIALING
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum IndicatorType {
  UF
  USD
  UTM
}

// --------------------
// Multi-tenant core
// --------------------

model Tenant {
  id            String           @id @default(cuid())
  slug          String           @unique
  name          String
  displayName   String
  isActive      Boolean          @default(true)
  primaryDomain String?
  domains       String[]         @default([])
  settings      Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  branding      TenantBranding?
  users         User[]
  companies     Company[]
  products      Product[]
  lots          Lot[]
  orders        Order[]
  purchases     Purchase[]
  quotes        Quote[]
  invoices      Invoice[]
  payments      Payment[]

  subscriptions Subscription[]
  contactPeople ContactPerson[]
  categories    Category[]
  warehouses    Warehouse[]
  purchaseOrders PurchaseOrder[]
  receptions     Reception[]
  priceLists     PriceList[]
  cashRegisters  CashRegister[]
  posShifts      PosShift[]

  @@map("tenants")
}

model TenantBranding {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  logoUrl          String?
  secondaryLogoUrl String?
  primaryColor     String?
  secondaryColor   String?
  accentColor      String?
  lightTheme       Json?
  darkTheme        Json?
  homeSections     Json?
  socialLinks      Json?
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

// --------------------
// User & company domain
// --------------------

model User {
  id               String   @id @default(cuid())
  tenantId         String
  email            String
  password         String
  firstName        String?
  lastName         String?
  role             UserRole @default(CLIENT)
  roles            Role[]   @relation("UserToRole")
  isActive         Boolean  @default(true)
  profilePictureUrl String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  posShifts        PosShift[]

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders    Order[]
  companies Company[]
  quotes    Quote[]

  @@index([tenantId])
  @@unique([tenantId, email])
  @@map("users")
}

model Company {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  name        String
  fantasyName String?
  rut         String?
  giro        String?
  address     String?
  city        String?
  state       String?
  zip         String?
  phone       String?
  email       String?
  isClient    Boolean  @default(false)
  isSupplier  Boolean  @default(false)
  createdAt   DateTime @now()
  updatedAt   DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactPeople ContactPerson[]
  quotes        Quote[]
  invoices      Invoice[]
  orders        Order[]
  purchases     Purchase[]
  purchaseOrders PurchaseOrder[]

  branches      Branch[]

  subscriptions Subscription[]

  @@index([tenantId])
  @@index([userId])
  @@unique([tenantId, rut])
  @@unique([tenantId, email])
  @@map("companies")
}

model ContactPerson {
  id          String   @id @default(cuid())
  tenantId    String
  companyId   String
  firstName   String
  lastName    String?
  email       String?
  phone       String?
  role        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@unique([tenantId, email])
  @@map("contact_people")
}

// --------------------
// Catalog & inventory
// --------------------

model Product {
  id                String      @id @default(cuid())
  tenantId          String
  name              String
  productType       ProductType @default(PRODUCT)
  sku               String?
  barcode           String?     @unique
  brand             String?
  description       String?
  longDescription   String?     @db.Text
  images            String[]    @default([])
  technicalSheetUrl String?
  category          String?
  categoryId        String?
  categoryRef       Category?   @relation(fields: [categoryId], references: [id])
  price             Decimal
  unitPrice         Decimal?
  unit              String?     @default("UN") // e.g. UN, KG, L
  reorderLevel      Int?
  isPublished       Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  purchaseItems PurchaseItem[]
  purchaseOrderItems PurchaseOrderItem[]
  receptionItems     ReceptionItem[]
  lots          Lot[]
  quoteItems    QuoteItem[]
  invoiceItems  InvoiceItem[]
  subscriptions Subscription[]
  productPrices ProductPrice[]

  @@index([tenantId])
  @@index([category])
  @@index([categoryId])
  @@index([isPublished])
  @@unique([tenantId, sku])
  @@map("products")
}

// ... rest of the file ...
